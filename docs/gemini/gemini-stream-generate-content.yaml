openapi: 3.1.0
info:
  title: Google Gemini StreamGenerateContent API
  version: v1beta
  description: |
    Gemini API的StreamGenerateContent端点，用于流式生成内容。

    使用 Server-Sent Events (SSE) 格式实时返回生成的内容。
    支持所有 GenerateContent 的功能，以流式方式输出。

    流式生成的优势：
    - 实时展示生成过程，提升用户体验
    - 适合长文本生成场景
    - 降低首字延迟（TTFB）
    - 支持函数调用参数的逐步构建

    支持的内容类型：
    - ✅ 文本生成（逐token流式输出）
    - ✅ 多模态理解（图片/视频分析的文字结果）
    - ✅ 函数调用（JSON参数逐步构建）
    - ✅ 代码执行（执行结果流式返回）
    - ✅ JSON模式输出（结构化数据逐步生成）
    - ❌ 图片生成（不支持流式，必须使用非流式API）

  contact:
    name: Google AI
    url: https://ai.google.dev/

  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: https://generativelanguage.googleapis.com/v1beta
    description: Gemini API v1beta endpoint

security:
  - ApiKeyHeader: []

paths:
  /models/{model}:streamGenerateContent:
    post:
      operationId: streamGenerateContent
      summary: 流式生成内容
      description: |
        使用指定的模型以流式方式生成内容。

        响应使用 Server-Sent Events (SSE) 格式，每个事件包含一个数据块。
        每个数据块的格式与非流式API相同（GenerateContentResponse），但只包含增量内容。

        **SSE 格式**:
        ```
        data: {"candidates":[{"content":{"parts":[{"text":"Hello"}]}}]}

        data: {"candidates":[{"content":{"parts":[{"text":" world"}]}}]}

        data: {"candidates":[{"content":{"parts":[{"text":"!"}],"finishReason":"STOP"}],"usageMetadata":{"totalTokenCount":8}}]
        ```

        可选查询参数: `?alt=sse`

      parameters:
        - name: model
          in: path
          required: true
          description: 模型名称
          schema:
            type: string
            examples:
              - gemini-pro
              - gemini-1.5-pro
              - gemini-1.5-flash

        - name: alt
          in: query
          required: false
          description: 响应格式（默认为 sse）
          schema:
            type: string
            enum:
              - sse
            default: sse

      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateContentRequest'
            examples:
              streamingBasic:
                summary: 基础流式文本生成
                value:
                  contents:
                    - parts:
                        - text: "Write a short story about a robot learning to paint"

              streamingWithConfig:
                summary: 带生成配置的流式
                value:
                  contents:
                    - parts:
                        - text: "Explain quantum computing in simple terms"
                  generationConfig:
                    temperature: 0.7
                    topP: 0.95
                    topK: 40
                    maxOutputTokens: 2048

              streamingMultiTurn:
                summary: 多轮对话流式
                value:
                  contents:
                    - role: user
                      parts:
                        - text: "What is machine learning?"
                    - role: model
                      parts:
                        - text: "Machine learning is a subset of AI that enables systems to learn from data."
                    - role: user
                      parts:
                        - text: "Can you give me an example?"

              streamingImageAnalysis:
                summary: 图片分析流式（输入图片，输出文字描述）
                value:
                  contents:
                    - parts:
                        - text: "Describe this image in detail"
                        - inlineData:
                            mimeType: "image/jpeg"
                            data: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="

              streamingVideoSummary:
                summary: 视频分析流式
                value:
                  contents:
                    - parts:
                        - text: "Summarize what happens in this video"
                        - fileData:
                            mimeType: "video/mp4"
                            fileUri: "https://generativelanguage.googleapis.com/v1beta/files/video_xyz"

              streamingMultiModal:
                summary: 混合多模态输入流式
                value:
                  contents:
                    - parts:
                        - text: "Compare these two images"
                        - inlineData:
                            mimeType: "image/png"
                            data: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
                        - inlineData:
                            mimeType: "image/png"
                            data: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8DwHwAFBQIAX8jx0gAAAABJRU5ErkJggg=="

              streamingFunctionCalling:
                summary: 函数调用流式（参数逐步构建）
                value:
                  contents:
                    - parts:
                        - text: "What's the weather in Tokyo and Paris?"
                  tools:
                    - functionDeclarations:
                        - name: get_weather
                          description: Get current weather for a location
                          parameters:
                            type: object
                            properties:
                              location:
                                type: string
                                description: City name
                              unit:
                                type: string
                                enum:
                                  - celsius
                                  - fahrenheit
                            required:
                              - location

              streamingJsonMode:
                summary: JSON模式流式输出
                value:
                  contents:
                    - parts:
                        - text: "List 5 programming languages with their use cases"
                  generationConfig:
                    responseMimeType: "application/json"

              streamingCodeExecution:
                summary: 代码执行流式
                value:
                  tools:
                    - codeExecution: {}
                  contents:
                    - parts:
                        - text: "Write Python code to calculate prime numbers up to 100 and execute it"

              streamingSystemInstruction:
                summary: 带系统指令的流式
                value:
                  systemInstruction:
                    parts:
                      - text: "You are a helpful coding assistant. Always provide detailed explanations."
                  contents:
                    - parts:
                        - text: "How do I implement binary search in Python?"

              streamingSafetySettings:
                summary: 带安全设置的流式
                value:
                  contents:
                    - parts:
                        - text: "Tell me about historical conflicts"
                  safetySettings:
                    - category: HARM_CATEGORY_DANGEROUS_CONTENT
                      threshold: BLOCK_MEDIUM_AND_ABOVE
                    - category: HARM_CATEGORY_HARASSMENT
                      threshold: BLOCK_ONLY_HIGH

              streamingFullFeatured:
                summary: 完整功能组合流式
                value:
                  systemInstruction:
                    parts:
                      - text: "You are a research assistant with access to tools."
                  tools:
                    - functionDeclarations:
                        - name: search_papers
                          description: Search academic papers
                          parameters:
                            type: object
                            properties:
                              query:
                                type: string
                              year:
                                type: integer
                  safetySettings:
                    - category: HARM_CATEGORY_HARASSMENT
                      threshold: BLOCK_MEDIUM_AND_ABOVE
                  generationConfig:
                    temperature: 0.8
                    topP: 0.9
                    maxOutputTokens: 4096
                    stopSequences:
                      - "END"
                  contents:
                    - role: user
                      parts:
                        - text: "Find recent papers about quantum computing"

      responses:
        '200':
          description: 流式响应（Server-Sent Events）
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  Server-Sent Events 流。每个事件格式为：

                  ```
                  data: <json_chunk>

                  ```

                  每个 JSON chunk 是 GenerateContentResponse 格式的增量数据。

              examples:
                streamingTextResponse:
                  summary: 流式文本响应示例
                  value: |
                    data: {"candidates":[{"content":{"parts":[{"text":"Once"}],"role":"model"}}],"usageMetadata":{"promptTokenCount":12}}

                    data: {"candidates":[{"content":{"parts":[{"text":" upon"}],"role":"model"}}]}

                    data: {"candidates":[{"content":{"parts":[{"text":" a"}],"role":"model"}}]}

                    data: {"candidates":[{"content":{"parts":[{"text":" time"}],"role":"model"}}]}

                    data: {"candidates":[{"content":{"parts":[{"text":"..."}],"role":"model"},"finishReason":"STOP","safetyRatings":[{"category":"HARM_CATEGORY_HARASSMENT","probability":"NEGLIGIBLE"}]}],"usageMetadata":{"candidatesTokenCount":50,"totalTokenCount":62}}

                streamingFunctionCallResponse:
                  summary: 流式函数调用响应
                  value: |
                    data: {"candidates":[{"content":{"parts":[{"functionCall":{"name":"get_weather","args":{}}}],"role":"model"}}]}

                    data: {"candidates":[{"content":{"parts":[{"functionCall":{"name":"get_weather","args":{"location":"Tokyo"}}}],"role":"model"}}]}

                    data: {"candidates":[{"content":{"parts":[{"functionCall":{"name":"get_weather","args":{"location":"Tokyo","unit":"celsius"}}}],"role":"model"},"finishReason":"STOP"}],"usageMetadata":{"totalTokenCount":45}}

        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '429':
          description: 速率限制
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    ApiKeyHeader:
      type: apiKey
      in: header
      name: x-goog-api-key
      description: Google AI API Key

  schemas:
    # ==================== 请求 Schema ====================
    # 复用 GenerateContent 的请求格式

    GenerateContentRequest:
      type: object
      required:
        - contents
      properties:
        contents:
          type: array
          description: 输入内容数组，支持多轮对话
          items:
            $ref: '#/components/schemas/Content'

        tools:
          type: array
          description: 可用工具列表（函数声明或代码执行）
          items:
            $ref: '#/components/schemas/Tool'

        toolConfig:
          $ref: '#/components/schemas/ToolConfig'

        safetySettings:
          type: array
          description: 安全设置
          items:
            $ref: '#/components/schemas/SafetySetting'

        systemInstruction:
          $ref: '#/components/schemas/SystemInstruction'

        generationConfig:
          $ref: '#/components/schemas/GenerationConfig'

    Content:
      type: object
      required:
        - parts
      properties:
        parts:
          type: array
          description: 内容部分数组
          items:
            $ref: '#/components/schemas/Part'
        role:
          type: string
          description: 角色（user 或 model）
          enum:
            - user
            - model

    Part:
      type: object
      description: 内容部分，可以是文本、图片、函数调用等
      properties:
        text:
          type: string
          description: 文本内容

        inlineData:
          $ref: '#/components/schemas/InlineData'

        fileData:
          $ref: '#/components/schemas/FileData'

        functionCall:
          $ref: '#/components/schemas/FunctionCall'

        functionResponse:
          $ref: '#/components/schemas/FunctionResponse'

        executableCode:
          $ref: '#/components/schemas/ExecutableCode'

        codeExecutionResult:
          $ref: '#/components/schemas/CodeExecutionResult'

    InlineData:
      type: object
      required:
        - mimeType
        - data
      properties:
        mimeType:
          type: string
          description: MIME类型
          examples:
            - image/png
            - image/jpeg
            - video/mp4
            - audio/wav
        data:
          type: string
          format: byte
          description: Base64编码的数据

    FileData:
      type: object
      required:
        - mimeType
        - fileUri
      properties:
        mimeType:
          type: string
          description: MIME类型
        fileUri:
          type: string
          description: 文件URI（通过File API上传）
          format: uri

    FunctionCall:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: 函数名称
        args:
          type: object
          description: 函数参数
          additionalProperties: true

    FunctionResponse:
      type: object
      required:
        - name
        - response
      properties:
        name:
          type: string
          description: 函数名称
        response:
          type: object
          description: 函数返回值
          additionalProperties: true

    ExecutableCode:
      type: object
      required:
        - code
      properties:
        language:
          type: string
          enum:
            - PYTHON
          default: PYTHON
        code:
          type: string
          description: 要执行的代码

    CodeExecutionResult:
      type: object
      required:
        - outcome
      properties:
        outcome:
          type: string
          enum:
            - OUTCOME_OK
            - OUTCOME_FAILED
            - OUTCOME_DEADLINE_EXCEEDED
        output:
          type: string
          description: 代码执行输出

    Tool:
      type: object
      properties:
        functionDeclarations:
          type: array
          description: 函数声明列表
          items:
            $ref: '#/components/schemas/FunctionDeclaration'

        codeExecution:
          type: object
          description: 代码执行工具（空对象表示启用）

    FunctionDeclaration:
      type: object
      required:
        - name
        - description
      properties:
        name:
          type: string
          description: 函数名称
        description:
          type: string
          description: 函数描述
        parameters:
          type: object
          description: JSON Schema格式的参数定义
          additionalProperties: true

    ToolConfig:
      type: object
      properties:
        functionCallingConfig:
          $ref: '#/components/schemas/FunctionCallingConfig'

    FunctionCallingConfig:
      type: object
      properties:
        mode:
          type: string
          enum:
            - AUTO
            - ANY
            - NONE
          description: |
            函数调用模式：
            - AUTO: 自动决定是否调用
            - ANY: 强制调用某个函数
            - NONE: 禁用函数调用
        allowedFunctionNames:
          type: array
          items:
            type: string
          description: 允许调用的函数名称列表

    SafetySetting:
      type: object
      required:
        - category
        - threshold
      properties:
        category:
          type: string
          enum:
            - HARM_CATEGORY_UNSPECIFIED
            - HARM_CATEGORY_HARASSMENT
            - HARM_CATEGORY_HATE_SPEECH
            - HARM_CATEGORY_SEXUALLY_EXPLICIT
            - HARM_CATEGORY_DANGEROUS_CONTENT
            - HARM_CATEGORY_CIVIC_INTEGRITY
        threshold:
          type: string
          enum:
            - HARM_BLOCK_THRESHOLD_UNSPECIFIED
            - BLOCK_NONE
            - BLOCK_ONLY_HIGH
            - BLOCK_MEDIUM_AND_ABOVE
            - BLOCK_LOW_AND_ABOVE

    SystemInstruction:
      type: object
      required:
        - parts
      properties:
        parts:
          type: array
          items:
            $ref: '#/components/schemas/Part'

    GenerationConfig:
      type: object
      properties:
        candidateCount:
          type: integer
          description: 生成的候选响应数量
          minimum: 1
          maximum: 8

        stopSequences:
          type: array
          items:
            type: string
          description: 停止序列
          maxItems: 5

        maxOutputTokens:
          type: integer
          description: 最大输出token数
          minimum: 1

        temperature:
          type: number
          description: 温度参数
          minimum: 0.0
          maximum: 2.0

        topP:
          type: number
          description: Nucleus sampling参数
          minimum: 0.0
          maximum: 1.0

        topK:
          type: integer
          description: Top-K sampling参数
          minimum: 1

        responseMimeType:
          type: string
          description: 响应MIME类型
          enum:
            - text/plain
            - application/json

        responseSchema:
          type: object
          description: JSON响应的schema定义
          additionalProperties: true

    # ==================== 流式响应 Schema ====================
    # 每个 chunk 都是 GenerateContentResponse 格式

    StreamChunk:
      type: object
      description: |
        流式数据块。格式与 GenerateContentResponse 相同，但每个块只包含增量内容。

        - 文本生成：每个块包含新生成的文本片段
        - 函数调用：参数逐步构建
        - 最后一个块：包含 finishReason 和完整的 usageMetadata

      properties:
        candidates:
          type: array
          description: 候选响应（增量）
          items:
            $ref: '#/components/schemas/Candidate'

        usageMetadata:
          $ref: '#/components/schemas/UsageMetadata'

    Candidate:
      type: object
      properties:
        content:
          $ref: '#/components/schemas/Content'

        finishReason:
          type: string
          enum:
            - FINISH_REASON_UNSPECIFIED
            - STOP
            - MAX_TOKENS
            - SAFETY
            - RECITATION
            - OTHER
          description: 仅在最后一个chunk中出现

        safetyRatings:
          type: array
          items:
            $ref: '#/components/schemas/SafetyRating'

        citationMetadata:
          $ref: '#/components/schemas/CitationMetadata'

        index:
          type: integer
          description: 候选响应的索引

    SafetyRating:
      type: object
      required:
        - category
        - probability
      properties:
        category:
          type: string
          enum:
            - HARM_CATEGORY_UNSPECIFIED
            - HARM_CATEGORY_HARASSMENT
            - HARM_CATEGORY_HATE_SPEECH
            - HARM_CATEGORY_SEXUALLY_EXPLICIT
            - HARM_CATEGORY_DANGEROUS_CONTENT
            - HARM_CATEGORY_CIVIC_INTEGRITY
        probability:
          type: string
          enum:
            - HARM_PROBABILITY_UNSPECIFIED
            - NEGLIGIBLE
            - LOW
            - MEDIUM
            - HIGH
        blocked:
          type: boolean

    CitationMetadata:
      type: object
      properties:
        citationSources:
          type: array
          items:
            $ref: '#/components/schemas/CitationSource'

    CitationSource:
      type: object
      properties:
        startIndex:
          type: integer
        endIndex:
          type: integer
        uri:
          type: string
          format: uri
        license:
          type: string

    UsageMetadata:
      type: object
      properties:
        promptTokenCount:
          type: integer
          description: 提示词token数量（仅在第一个chunk）
        candidatesTokenCount:
          type: integer
          description: 候选响应token数量（仅在最后一个chunk）
        totalTokenCount:
          type: integer
          description: 总token数量（仅在最后一个chunk）
        cachedContentTokenCount:
          type: integer
          description: 缓存内容token数量

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          properties:
            code:
              type: integer
            message:
              type: string
            status:
              type: string
